<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>YOHOU US Stock AI</title>
<script src="https://cdn.tailwindcss.com/3.4.16"></script>
<script>tailwind.config={theme:{extend:{colors:{primary:'#2563EB',secondary:'#DC2626'},borderRadius:{'none':'0px','sm':'4px',DEFAULT:'8px','md':'12px','lg':'16px','xl':'20px','2xl':'24px','3xl':'32px','full':'9999px','button':'8px'}}}}</script>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@300;400;500;600;700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/remixicon/4.6.0/remixicon.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/echarts/5.5.0/echarts.min.js"></script>
    <script src="translations/load.js"></script>
    <script src="lang.js"></script>
<!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-90LPDJBXLY"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());
  gtag('config', 'G-90LPDJBXLY');
</script>
<style>
header img { height: 40px; }
body { font-family: 'Noto Sans JP', sans-serif; background-color: #F8FAFC; color: #1F2937; }
.date-picker .day.selected { background-color: #DBEAFE; color: #1D4ED8; font-weight: 500; }
.date-picker .day.in-range { background-color: #EFF6FF; }
.date-picker .day.start-date { background-color: #2563EB; color: white; }
.date-picker .day.end-date { background-color: #2563EB; color: white; }
.calendar-day.has-report:hover { transform: translateY(-2px); box-shadow: 0 4px 6px -1px rgba(0,0,0,.1), 0 2px 4px -2px rgba(0,0,0,.1); }
</style>
</head>
<body class="min-h-screen">

<header class="bg-white border-b border-gray-200">
    <div class="container mx-auto px-4 py-4">
        <div class="flex items-center justify-between">
            <div class="flex items-center space-x-8">
                <a href="index.html"><img src="image/logo.png" alt="YOHOU US Stocks AI" class="h-10"></a>
                <nav class="hidden md:flex space-x-6 text-gray-600">
                    <a href="index.html" class="hover:text-primary" data-lang="nav_today">本日の市況分析</a>
                    <a href="archive.html" class="text-primary font-medium border-b-2 border-primary pb-1" data-lang="nav_archive">分析アーカイブ</a>
                    <a href="indicators.html" class="text-gray-600 hover:text-primary" data-lang="nav_indicators">テクニカル指標解説</a>
                    <a href="terms.html" class="text-gray-600 hover:text-primary" data-lang="nav_terms">市場用語集</a>
                    <a href="about.html" class="text-gray-600 hover:text-primary" data-lang="nav_about">サイトについて</a>
                </nav>
            </div>
            <div class="flex items-center space-x-1 md:space-x-4">
                <button id="login-btn" class="hidden md:flex items-center space-x-2 text-gray-600 hover:text-primary cursor-not-allowed opacity-50"><i class="ri-user-line"></i><span data-lang="login">ログイン</span></button>
                <button id="register-btn" class="bg-primary text-white px-2 md:px-4 py-2 rounded-button font-medium hover:bg-primary/90 transition whitespace-nowrap cursor-not-allowed opacity-50 text-xs md:text-sm" data-lang="register">無料登録</button>
                <!-- 言語切り替えボタンをヘッダー内に配置 -->
                <div id="header-lang-switcher" class="flex items-center space-x-2 mr-2 md:mr-4">
                    <button class="lang-btn bg-primary text-white px-2 py-1 rounded text-xs font-medium transition-colors" data-lang="ja">日本語</button>
                    <span class="text-gray-400 text-xs">|</span>
                    <button class="lang-btn bg-gray-100 text-gray-700 px-2 py-1 rounded text-xs font-medium transition-colors" data-lang="en">EN</button>
                </div>
                <button id="mobile-menu-button" class="md:hidden text-gray-600 ml-2 hover:text-primary transition-colors">
                    <i class="ri-menu-line ri-lg"></i>
                </button>
            </div>
        </div>
    </div>
</header>

<!-- モバイルメニュー -->
<div id="mobile-menu" class="md:hidden hidden bg-white border-b border-gray-200 shadow-lg">
    <div class="px-4 py-2 space-y-1">
        <a href="index.html" class="block px-3 py-2 text-gray-600 hover:text-primary hover:bg-gray-50 transition-colors" data-lang="nav_today">本日の市況分析</a>
        <a href="archive.html" class="block px-3 py-2 text-primary font-medium border-l-4 border-primary bg-blue-50" data-lang="nav_archive">分析アーカイブ</a>
        <a href="indicators.html" class="block px-3 py-2 text-gray-600 hover:text-primary hover:bg-gray-50 transition-colors" data-lang="nav_indicators">テクニカル指標解説</a>
        <a href="terms.html" class="block px-3 py-2 text-gray-600 hover:text-primary hover:bg-gray-50 transition-colors" data-lang="nav_terms">市場用語集</a>
        <a href="about.html" class="block px-3 py-2 text-gray-600 hover:text-primary hover:bg-gray-50 transition-colors" data-lang="nav_about">サイトについて</a>
        <div class="border-t border-gray-200 pt-2 mt-2">
            <button class="block w-full text-left px-3 py-2 text-gray-600 hover:text-primary hover:bg-gray-50 transition-colors" data-lang="login">ログイン</button>
            <button class="block w-full text-left px-3 py-2 bg-primary text-white hover:bg-primary/90 rounded-md mx-3 mt-2 transition-colors" data-lang="register">無料登録</button>
        </div>
    </div>
</div>

<main class="container mx-auto px-4 py-6 max-w-7xl">
    <div class="mb-8">
        <h1 class="text-2xl font-bold mb-2" data-lang="archive_title">分析アーカイブ</h1>
        <p class="text-gray-600" data-lang="archive_subtitle">過去の市場分析レポートを閲覧できます。日付やキーワードで検索して、必要な情報を素早く見つけましょう。</p>
    </div>

    <div class="bg-white rounded-lg shadow-sm border border-gray-100 p-4 mb-8">
        <div class="flex flex-col md:flex-row gap-4 items-center">
            <div class="flex-1 relative"><input type="text" id="keyword-search" placeholder="キーワードで検索" class="w-full pl-10 pr-4 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary/20 focus:border-primary text-sm"><div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none"><i class="ri-search-line text-gray-400"></i></div></div>
            <div class="md:w-64 relative date-picker-container"><button id="date-range-btn" class="w-full flex items-center justify-between px-4 py-2 border border-gray-300 rounded-md bg-white text-sm text-gray-700 focus:outline-none focus:ring-2 focus:ring-primary/20 focus:border-primary"><span id="selected-date-range">期間を選択</span><i class="ri-calendar-line ml-2 text-gray-400"></i></button><div id="date-picker" class="date-picker hidden absolute top-full left-0 z-10 w-72 bg-white rounded-lg shadow-lg p-4 mt-1"><div class="flex justify-between items-center mb-4"><button id="dp-prev-month" class="text-gray-600 hover:text-primary"><i class="ri-arrow-left-s-line ri-lg"></i></button><div id="dp-month-year" class="font-medium"></div><button id="dp-next-month" class="text-gray-600 hover:text-primary"><i class="ri-arrow-right-s-line ri-lg"></i></button></div><div class="grid grid-cols-7 gap-1 text-center text-xs text-gray-500 mb-2"><div>日</div><div>月</div><div>火</div><div>水</div><div>木</div><div>金</div><div>土</div></div><div id="dp-grid" class="grid grid-cols-7 gap-1"></div><div class="mt-4 flex justify-between"><button id="dp-today" class="text-xs text-gray-600 hover:text-primary">今日</button><div><button id="dp-cancel" class="text-xs text-gray-600 hover:text-primary mr-2">キャンセル</button><button id="dp-apply" class="text-xs bg-primary text-white px-3 py-1 rounded-button">適用</button></div></div></div></div>
            <div class="md:w-48"><select id="evaluation-select" class="w-full px-4 py-2 border border-gray-300 rounded-md bg-white text-sm text-gray-700 focus:outline-none focus:ring-2 focus:ring-primary/20 focus:border-primary pr-8 appearance-none"><option value="">評価を選択</option><option value="買い">買い</option><option value="売り">売り</option><option value="中立">中立</option></select></div>
        </div>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-12 gap-8">
        <aside class="lg:col-span-3 order-2 lg:order-1"><div class="sticky top-6"><div class="bg-white rounded-lg shadow-sm border border-gray-100 p-4 mb-6"><h3 class="text-lg font-medium mb-4" data-lang="period">期間</h3><div id="period-filter-group" class="space-y-3"><div class="flex items-center"><input type="radio" id="period-all" value="all" name="period" class="custom-radio" checked><label for="period-all" class="ml-2 text-sm text-gray-700" data-lang="period_all">全期間</label></div><div class="flex items-center"><input type="radio" id="period-1w" value="1w" name="period" class="custom-radio"><label for="period-1w" class="ml-2 text-sm text-gray-700" data-lang="period_1w">1週間</label></div><div class="flex items-center"><input type="radio" id="period-1m" value="1m" name="period" class="custom-radio"><label for="period-1m" class="ml-2 text-sm text-gray-700" data-lang="period_1m">1ヶ月</label></div><div class="flex items-center"><input type="radio" id="period-3m" value="3m" name="period" class="custom-radio"><label for="period-3m" class="ml-2 text-sm text-gray-700" data-lang="period_3m">3ヶ月</label></div></div></div><div class="bg-white rounded-lg shadow-sm border border-gray-100 p-4 mb-6"><h3 class="text-lg font-medium mb-4" data-lang="evaluation_stats">評価別統計</h3><div id="stats-container" class="space-y-4"></div></div></div></aside>
        <div class="lg:col-span-9 order-1 lg:order-2"><div id="list-view" class="space-y-6"></div></div>
    </div>
</main>

<footer class="bg-gray-50 border-t border-gray-200 mt-12"><div class="container mx-auto px-4 py-8 text-center"><p class="text-sm text-gray-600" data-lang="footer_copyright">© 2025 YOHOU Nikkei AI. All rights reserved.</p><p class="text-xs text-gray-500 mt-2" data-lang="footer_disclaimer_short">当サイトの情報は投資判断の参考として提供されるものであり、投資勧誘を目的としたものではありません。</p></div></footer>

<script>
    // 日本語テキストから英語を自動生成する辞書（index.htmlと同じ）
    const translationDict = {
        // 評価関連
        '買い': 'Buy',
        '売り': 'Sell',
        'ホールド': 'Hold',
        '中立': 'Neutral',
        
        // 市場状況
        '史上最高値圏': 'near all-time highs',
        '史上最高値': 'all-time high',
        '市場': 'market',
        '投資家': 'investors',
        'プロ投資家': 'professional investors',
        '個人投資家': 'individual investors',
        '短期トレーダー': 'short-term traders',
        'リスク管理': 'risk management',
        '最高値圏': 'near all-time highs',
        '記録更新の裏に潜む疲弊の兆候': 'signs of exhaustion lurking behind record-breaking performance',
        '市場は自らの成功の重みに耐えられるか': 'can the market withstand the weight of its own success',
        '記録更新': 'record-breaking',
        
        // 重要な文章レベルの翻訳
        'S&P 500は史上最高値圏にありますが、内部指標は深刻な悪化を示しています。プロ投資家の熱狂と個人投資家の慎重さの乖離は逆張りの売りシグナルです。短期トレーダーはリスク管理を最優先し、高値追いを控えるべき局面です。': 'S&P 500 is near all-time highs, but internal indicators show serious deterioration. The divergence between professional investor euphoria and individual investor caution is a contrarian sell signal. Short-term traders should prioritize risk management and avoid chasing highs in this phase.',
        
        // その他の詳細な翻訳は省略（index.htmlから必要に応じて追加）
        '値上がり銘柄数が値下がり銘柄数を上回っていますが': 'advancing stocks outnumber declining stocks, but',
        '一部主要銘柄の急落はラリーの脆弱性を示唆しています': 'sharp declines in some major stocks suggest rally fragility',
        
        // 日付・調査
        '2025年7月28日': 'July 28, 2025',
        '7月28日 市場分析': 'July 28 Market Analysis',
        
        // 一般的な助詞・語尾（空文字列に変換）
        'について': '',
        'による': '',
        'によって': '',
        'である': '',
        'です': '',
        'ます': '',
        'した': '',
        'する': '',
        'しています': '',
        'としている': '',
        'と': ' and ',
        'が': ' ',
        'は': ' ',
        'を': ' ',
        'に': ' ',
        'の': ' ',
        'で': ' '
    };

    // 日本語テキストを英語に自動翻訳する関数
    function autoTranslateText(japaneseText) {
        if (!japaneseText) return '';
        
        let englishText = japaneseText;
        
        // 長いフレーズから短いものの順で置換
        const sortedEntries = Object.entries(translationDict).sort((a, b) => b[0].length - a[0].length);
        
        sortedEntries.forEach(([japanese, english]) => {
            if (english) {
                const regex = new RegExp(japanese.replace(/[.*+?^${}()|[\]\\]/g, '\\$&'), 'g');
                englishText = englishText.replace(regex, english);
            }
        });
        
        // 特定の日本語パターンの変換
        englishText = englishText
            .replace(/(\d+)年(\d+)月(\d+)日/g, (match, year, month, day) => {
                const months = ['January', 'February', 'March', 'April', 'May', 'June',
                               'July', 'August', 'September', 'October', 'November', 'December'];
                return `${months[parseInt(month)-1]} ${parseInt(day)}, ${year}`;
            })
            .replace(/。/g, '. ')
            .replace(/、/g, ', ')
            .replace(/：/g, ': ')
            .replace(/（/g, ' (')
            .replace(/）/g, ') ')
            .replace(/\s+/g, ' ')
            .replace(/^\s*([a-z])/g, (match, p1) => match.replace(p1, p1.toUpperCase()))
            .replace(/\.\s+([a-z])/g, (match, p1) => match.replace(p1, p1.toUpperCase()))
            .trim();
            
        return englishText;
    }

    // オブジェクトを再帰的に翻訳する関数
    function translateObjectRecursively(obj) {
        if (typeof obj === 'string') {
            return autoTranslateText(obj);
        } else if (Array.isArray(obj)) {
            return obj.map(item => translateObjectRecursively(item));
        } else if (obj !== null && typeof obj === 'object') {
            const translated = {};
            for (const [key, value] of Object.entries(obj)) {
                translated[key] = translateObjectRecursively(value);
            }
            return translated;
        }
        return obj;
    }

    // 日本語データから英語データを自動生成する関数
    function generateEnglishData(japaneseData) {
        return translateObjectRecursively(japaneseData);
    }

    // アーカイブデータを多言語対応する関数
    function processArchiveDataForLanguage(data) {
        const currentLang = window.currentLang || 'ja';
        
        if (currentLang === 'en') {
            // 英語の場合、各フィールドを翻訳
            return {
                ...data,
                date: autoTranslateText(data.date),
                session: autoTranslateText(data.session),
                evaluation: autoTranslateText(data.evaluation),
                headline: autoTranslateText(data.headline),
                summary: autoTranslateText(data.summary)
            };
        }
        
        return data; // 日本語の場合はそのまま返す
    }

document.addEventListener('DOMContentLoaded', () => {
    // DOM Elements
    const listView = document.getElementById('list-view');
    const statsContainer = document.getElementById('stats-container');
    const evaluationSelect = document.getElementById('evaluation-select');
    const periodFilterGroup = document.getElementById('period-filter-group');
    const keywordSearch = document.getElementById('keyword-search');
    const dateRangeBtn = document.getElementById('date-range-btn');
    const datePicker = document.getElementById('date-picker');
    const selectedDateRange = document.getElementById('selected-date-range');
    const dpMonthYear = document.getElementById('dp-month-year');
    const dpGrid = document.getElementById('dp-grid');
    const dpPrevMonthBtn = document.getElementById('dp-prev-month');
    const dpNextMonthBtn = document.getElementById('dp-next-month');
    const dpTodayBtn = document.getElementById('dp-today');
    const dpCancelBtn = document.getElementById('dp-cancel');
    const dpApplyBtn = document.getElementById('dp-apply');

    // State
    let allReports = [];
    let filteredReports = [];
    let dpState = {
        visible: false,
        year: new Date().getFullYear(),
        month: new Date().getMonth(),
        startDate: null,
        endDate: null,
    };

    // --- Utility Functions ---
    const parseJapaneseDate = (dateString) => {
        const parts = dateString.match(/(\d{4})年(\d{1,2})月(\d{1,2})日/);
        if (!parts) return null;
        const [_, year, month, day] = parts.map(p => parseInt(p, 10));
        return new Date(year, month - 1, day);
    };

    const formatDate = (date) => date ? `${date.getFullYear()}年${date.getMonth() + 1}月${date.getDate()}日}` : '';

    // 評価値の正規化関数を追加
    function normalizeEvaluation(evaluation) {
        if (!evaluation) return '';
        if (evaluation.includes('売り') || evaluation.includes('弱気')) return getTranslation('eval_sell');
        if (evaluation.includes('買い') || evaluation.includes('強気')) return getTranslation('eval_buy');
        if (evaluation.includes('中立')) return getTranslation('eval_neutral');
        return evaluation;
    }

    // --- Data Loading ---
    async function loadAndInitialize() {
        try {
            const manifestResponse = await fetch('/archive_data/manifest.json');
            if (!manifestResponse.ok) throw new Error('Manifest file not found');
            const archiveList = await manifestResponse.json();

            // manifest.jsonの各オブジェクトをallReportsに格納（言語対応処理も適用）
            allReports = archiveList.map(item => {
                const processedItem = processArchiveDataForLanguage({
                    date: item.date,
                    session: item.session,
                    evaluation: item.evaluation,
                    headline: item.headline,
                    summary: item.summary,
                    file: item.file,
                    parsedDate: parseJapaneseDate(item.date)
                });
                return processedItem;
            }).sort((a, b) => b.parsedDate - a.parsedDate);
            filteredReports = [...allReports];
            
            initializeFilters();
            renderAll();
        } catch (error) {
            console.error('Error loading archive data:', error);
            listView.innerHTML = '<p class="text-center text-red-500">レポートの読み込みに失敗しました。</p>';
        }
    }

    // --- Rendering ---
    function renderAll() {
        renderReports(filteredReports);
        updateStats(allReports); // Stats should always reflect the total
    }

    function renderReports(reports) {
        listView.innerHTML = '';
        if (reports.length === 0) {
            const currentLang = window.currentLang || 'ja';
            const noReportsMessage = currentLang === 'en' ? 'No reports to display.' : '表示するレポートがありません。';
            listView.innerHTML = `<p class="text-center p-10 text-gray-500">${noReportsMessage}</p>`;
            return;
        }
        reports.forEach(data => {
            const card = document.createElement('div');
            card.className = 'report-card bg-white rounded-lg shadow-sm border border-gray-100 p-6 transition-shadow hover:shadow-md';
            const normalizedEval = normalizeEvaluation(data.evaluation);
            const evalClass = normalizedEval === '売り' ? 'bg-red-100 text-red-700' : (normalizedEval === '買い' ? 'bg-blue-100 text-blue-700' : 'bg-gray-100 text-gray-700');
            card.innerHTML = `
                <div class="flex items-center justify-between mb-4">
                    <div class="flex items-center space-x-3 text-sm text-gray-600"><span>${data.date}</span><span>|</span><span>${data.session}</span></div>
                    <div class="px-3 py-1 rounded-full ${evalClass} font-medium text-sm">${data.evaluation}</div>
                </div>
                <h3 class="text-2xl font-bold mb-2 text-gray-800">${data.headline}</h3>
                <p class="text-lg text-gray-600 mb-4 leading-relaxed">${data.summary.substring(0, 100)}...</p>
                <div class="text-right"><a href="index.html?datafile=${data.file}" class="text-primary font-semibold hover:underline">${getTranslation('view_details')} <i class="ri-arrow-right-line align-middle"></i></a></div>`;
            listView.appendChild(card);
        });
    }

    function updateStats(reports) {
        const total = reports.length;
        const counts = { [getTranslation('eval_buy')]: 0, [getTranslation('eval_neutral')]: 0, [getTranslation('eval_sell')]: 0 };
        reports.forEach(r => {
            const normalizedEval = normalizeEvaluation(r.evaluation);
            if(counts[normalizedEval] !== undefined) counts[normalizedEval]++;
        });

        statsContainer.innerHTML = Object.entries(counts).map(([rating, count]) => {
            const colorClass = rating === getTranslation('eval_buy') ? 'primary' : (rating === getTranslation('eval_sell') ? 'secondary' : 'gray-500');
            const width = total > 0 ? (count / total * 100) : 0;
            return `
                <div class="stats-item p-2 hover:bg-gray-50 rounded-md cursor-pointer transition" data-rating="${rating}">
                    <div class="flex justify-between items-center mb-1">
                        <span class="text-sm font-medium text-${colorClass}">${rating}</span>
                        <span class="text-sm text-gray-600">${count}${getTranslation('cases')}</span>
                    </div>
                    <div class="w-full bg-gray-200 rounded-full h-2"><div class="bg-${colorClass} h-2 rounded-full" style="width: ${width}%"></div></div>
                </div>`;
        }).join('');
        
        statsContainer.querySelectorAll('.stats-item').forEach(item => {
            item.addEventListener('click', () => {
                evaluationSelect.value = item.dataset.rating;
                applyFilters();
            });
        });
        
        // Listen for language changes and re-render dynamic content
        document.addEventListener('languageChanged', function(e) {
            // 言語変更時にデータを再処理
            loadAndInitialize();
        });
    }

    // --- Date Picker Logic ---
    function renderDatePicker() {
        dpMonthYear.textContent = `${dpState.year}年 ${dpState.month + 1}月`;
        dpGrid.innerHTML = '';
        const firstDay = new Date(dpState.year, dpState.month, 1).getDay();
        const daysInMonth = new Date(dpState.year, dpState.month + 1, 0).getDate();

        for (let i = 0; i < firstDay; i++) dpGrid.insertAdjacentHTML('beforeend', '<div></div>');

        for (let i = 1; i <= daysInMonth; i++) {
            const day = document.createElement('div');
            day.textContent = i;
            day.className = 'day text-center p-1 text-xs cursor-pointer rounded-sm hover:bg-gray-100';
            const date = new Date(dpState.year, dpState.month, i);
            
            if (dpState.startDate && date.getTime() === dpState.startDate.getTime()) day.classList.add('start-date');
            if (dpState.endDate && date.getTime() === dpState.endDate.getTime()) day.classList.add('end-date');
            if (dpState.startDate && dpState.endDate && date > dpState.startDate && date < dpState.endDate) day.classList.add('in-range');
            
            dpGrid.appendChild(day);
        }
    }

    function initializeDatePicker() {
        dateRangeBtn.addEventListener('click', () => {
            dpState.visible = !dpState.visible;
            datePicker.classList.toggle('hidden', !dpState.visible);
        });

        dpGrid.addEventListener('click', (e) => {
            if (e.target.classList.contains('day')) {
                const day = parseInt(e.target.textContent, 10);
                const date = new Date(dpState.year, dpState.month, day);
                if (!dpState.startDate || dpState.endDate) {
                    dpState.startDate = date;
                    dpState.endDate = null;
                } else if (date < dpState.startDate) {
                    dpState.startDate = date;
                } else {
                    dpState.endDate = date;
                }
                renderDatePicker();
            }
        });

        dpPrevMonthBtn.addEventListener('click', () => {
            dpState.month--;
            if (dpState.month < 0) { dpState.month = 11; dpState.year--; }
            renderDatePicker();
        });

        dpNextMonthBtn.addEventListener('click', () => {
            dpState.month++;
            if (dpState.month > 11) { dpState.month = 0; dpState.year++; }
            renderDatePicker();
        });

        dpApplyBtn.addEventListener('click', () => {
            if (dpState.startDate && dpState.endDate) {
                selectedDateRange.textContent = `${formatDate(dpState.startDate)} - ${formatDate(dpState.endDate)}`;
                dpState.visible = false;
                datePicker.classList.add('hidden');
                document.getElementById('period-all').checked = true;
                applyFilters();
            }
        });
        
        dpCancelBtn.addEventListener('click', () => {
            dpState.visible = false;
            datePicker.classList.add('hidden');
        });

        dpTodayBtn.addEventListener('click', () => {
            const today = new Date();
            dpState.year = today.getFullYear();
            dpState.month = today.getMonth();
            dpState.startDate = today;
            dpState.endDate = today;
            renderDatePicker();
        });
    }

    // --- Filtering Logic ---
    function applyFilters() {
        let reports = [...allReports];
        
        // Keyword
        const keyword = keywordSearch.value.toLowerCase();
        if (keyword) {
            reports = reports.filter(r => r.headline.toLowerCase().includes(keyword) || r.summary.text.toLowerCase().includes(keyword));
        }

        // Evaluation
        const evaluation = evaluationSelect.value;
        if (evaluation) {
            reports = reports.filter(r => normalizeEvaluation(r.evaluation) === evaluation);
        }

        // Period Radio / Date Picker
        const checkedPeriod = periodFilterGroup.querySelector('input[name="period"]:checked').value;
        if (checkedPeriod !== 'all') {
            const now = new Date();
            let startDate = new Date();
            if (checkedPeriod === '1w') startDate.setDate(now.getDate() - 7);
            else if (checkedPeriod === '1m') startDate.setMonth(now.getMonth() - 1);
            else if (checkedPeriod === '3m') startDate.setMonth(now.getMonth() - 3);
            reports = reports.filter(r => r.parsedDate >= startDate && r.parsedDate <= now);
        } else if (dpState.startDate && dpState.endDate) {
             // Date picker has priority if "All time" is selected
            reports = reports.filter(r => r.parsedDate >= dpState.startDate && r.parsedDate <= dpState.endDate);
        }
        
        filteredReports = reports;
        renderReports(filteredReports);
    }

    function initializeFilters() {
        keywordSearch.addEventListener('input', applyFilters);
        evaluationSelect.addEventListener('change', applyFilters);
        periodFilterGroup.addEventListener('change', () => {
            // Clear date picker selection when a radio button is clicked
            dpState.startDate = null;
            dpState.endDate = null;
            selectedDateRange.textContent = '期間を選択';
            applyFilters();
        });
        initializeDatePicker();
    }

    // --- Initial Load ---
    loadAndInitialize();

    // 未実装機能のアラート
    document.getElementById('login-btn').addEventListener('click', () => {
        alert('この機能は現在準備中です。ご期待ください！');
    });
    document.getElementById('register-btn').addEventListener('click', () => {
        alert('この機能は現在準備中です。ご期待ください！');
    });

    // renderAll関数をグローバルに公開（lang.jsから呼び出すため）
    window.renderAll = renderAll;

    // Initialize language system first
    window.currentLang = localStorage.getItem('language') || 'ja';
    
    // Initialize lang.js language system
    if (window.initLanguage) {
        initLanguage();
    }
    
    // Initialize mobile menu
    initializeMobileMenu();
    
    // Initialize archive data after language setup
    loadAndInitialize();
});

// Mobile menu functionality
function initializeMobileMenu() {
    const mobileMenuButton = document.getElementById('mobile-menu-button');
    const mobileMenu = document.getElementById('mobile-menu');
    const menuIcon = mobileMenuButton.querySelector('i');
    
    if (mobileMenuButton && mobileMenu) {
        mobileMenuButton.addEventListener('click', function() {
            const isHidden = mobileMenu.classList.contains('hidden');
            
            if (isHidden) {
                // メニューを開く
                mobileMenu.classList.remove('hidden');
                menuIcon.className = 'ri-close-line ri-lg';
            } else {
                // メニューを閉じる
                mobileMenu.classList.add('hidden');
                menuIcon.className = 'ri-menu-line ri-lg';
            }
        });
        
        // メニューリンクをクリックしたときにメニューを閉じる
        const menuLinks = mobileMenu.querySelectorAll('a');
        menuLinks.forEach(link => {
            link.addEventListener('click', function() {
                mobileMenu.classList.add('hidden');
                menuIcon.className = 'ri-menu-line ri-lg';
            });
        });
        
        // メニュー外をクリックしたときにメニューを閉じる
        document.addEventListener('click', function(event) {
            if (!mobileMenuButton.contains(event.target) && !mobileMenu.contains(event.target)) {
                mobileMenu.classList.add('hidden');
                menuIcon.className = 'ri-menu-line ri-lg';
            }
        });
    }
}
</script>
</body>
</html>